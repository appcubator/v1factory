{% extends "infra-editor.html" %}

{% block css %}
<link href="{{ STATIC_URL }}css/reset.css" rel="stylesheet">
<link href="{{ STATIC_URL }}css/editor.css" rel="stylesheet">
<link href="{{ STATIC_URL }}css/bootstrap.css" rel="stylesheet">
<link href="{{ STATIC_URL }}css/design.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.10.1/themes/base/jquery-ui.css">
<script type="text/javascript" src="{{ STATIC_URL }}js/jscolor/jscolor.js"></script>
<style type="text/css">
{% for element in gallery_elements %}
.{{element.class_name }} {
{{ element.css }}
}
{% endfor %}
</style>
{% endblock %}

{% block navbar %}
<!-- <div class="navbar navbar-inverse navbar-fixed-top editing">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>
      <a class="brand" href="#">Project name</a>
    </div>
  </div>
</div> -->
{% endblock %}

{% block page %}
{% include "dev/editor-gallery.html" %}
<div class="container editing" id="elements-container">
  <div class="elements-inside-container" id="widgets-container"></div>
</div>
<div class="container editing" id="body-container"></div>
{% include "dev/editor-settings.html" %}
{% include "dev/editor-info.html" %}
<div class="loading-gif" id="loading-gif">
  <div class="logo offsetr2 hoff1">
    <span class="engine1"></span>
    <span class="engine2"></span>
  </div>
</div>
{% endblock %}

{% block js %}
<script type="text/javascript">
var appState = {{ app.state_json|safe }};
var statics = {{ statics|safe }};
var myUIElements = {{ myuielements|safe }};
var library = {{ elements|safe }};
var pageId = {{ page_id }};

</script>
{% include "dev/editor-templates.html" %}
<script type="text/javascript" src="http://code.jquery.com/ui/1.10.0/jquery-ui.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/iui.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/lang.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/default-uielements.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/tag-dict.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/design-options.js"></script>

<script type="text/javascript" src="{{ STATIC_URL }}js/models.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/collections.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/design-options.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/editor-grid.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/editor-widgets.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/editor-entities.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/editor-info.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/editor-list.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/editor-pages.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/design-editor-view.js"></script>

<script type="text/javascript" src="{{ STATIC_URL }}js/list.js"></script>

<script type="text/javascript">
var GRID_WIDTH = 15;
var GRID_HEIGHT = 15;

// var entitiesColl   = new EntityCollection();
// var widgetInfoView = new WidgetInfoView();

// var 

// contextColl.add(contextEntities);
// entitiesColl.add(appState.entities);

// $(function() {$( "#item-info-section" ).draggable();});

var EditorView = Backbone.View.extend({
  el        : document.body,
  className : 'sample',

  events    : {
    'click #save'          : 'save',
    'click #settings'      : 'showSettings',
    'click #settings-cross': 'hideSettings'

  },
  
  initialize: function() {
    _.bindAll(this, 'save',
                    'hideSettings',
                    'showSettings',
                    'getContextEntities');
    
    var page = appState.pages[pageId];
    var contextEntites = this.getContextEntities();

    this.model            = new PageModel(page);
    this.entityCollection = new EntityCollection();
    this.contextCollection= new EntityCollection();

    console.log(this.model);

    this.galleryEditor = new GalleryView(this.contextCollection, this.entityCollection);
    this.widgetEditor  = new WidgetEditorView(contextEntites, page);
    this.gridEditor    = new GridEditorView();
    this.designEditor  = new DesignEditorView(this.model, true);

    this.entityCollection.add(appState.entities);
    this.contextCollection.add(contextEntites);

    this.render();
    $('#loading-gif').fadeOut().remove();
  },

  render: function() {
    this.el.appendChild(this.galleryEditor.el);
    this.el.appendChild(this.widgetEditor.el);
    this.el.appendChild(this.gridEditor.el);
    this.el.appendChild(this.designEditor.el);
  },

  save : function() {
    appState.pages[pageInd]['uielements'] = (this.widgetEditor.serializeWidgets() || []);
    appState.pages[pageInd]['design_props'] = (this.designEditor.model.toJSON()['design_props']||[]);
    
    $.ajax({
      type: "POST",
      url: '/app/1/state/',
      data: JSON.stringify(appState),
      success: function() {},
      dataType: "JSON"
    });
  },

  showSettings: function() {
    $('#page-settings').animate({
      marginBottom : -10
    });
    return false;
  },

  hideSettings: function() {
    $('#page-settings').animate({
      marginBottom : '-100%'
    });
    return false;   
  },

  getContextEntities: function() {
    var name = appState.pages[pageId].name;
    var page = _.where(appState.urls, {page_name: name})[0];
    if(!page) {
      return [];
    }
    var contextEntites = _.filter(page.urlparts, function(str){ return (/\{\{([^\}]+)\}\}/g.exec(str)); });
    contextEntites = _.map(contextEntites, function(str){ return (/\{\{([^\}]+)\}\}/g.exec(str))[1];});
    return contextEntites;
  }

});

var editorView = new EditorView();
</script>
<script type="text/javascript">
</script>
{% endblock %}

