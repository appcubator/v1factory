define(["app/collections/ElementCollection","app/models/UserEntityModel","backbone","iui"],function(e,t,n){var r=n.View.extend({el:iui.get("top-panel-bb"),allList:iui.get("all-list"),elementsList:iui.get("interface-list"),dataList:iui.get("entities-list"),userList:iui.get("user-list"),widgetsCollection:null,containersCollection:null,curId:"all-elements",dragActive:!1,events:{"click .header":"sectionClicked"},initialize:function(t,n){_.bindAll(this,"render","appendEntity","appendContextEntity","appendElement","appendUserElements","dropped","setupSearch"),this.elementsCollection=new e,this.widgetsCollection=t,this.containersCollection=n,this.elementsCollection.bind("add",this.appendElement,this),this.render(),this.elementsCollection.add(defaultElements)},render:function(){return this},appendUserElements:function(){},appendEntity:function(e){var t=this,n={name:e.get("name"),cid:e.cid};$(this.allList).append(_.template(Templates.tempLiEntity,n)),$(this.allList).append(_.template(Templates.tempLiTable,n)),e.has("forms")&&_(e.get("forms").models).each(function(n){if(n.get("action")=="create"){var r=_.template(Templates.createFormButton,{entity:e,form:n});$(t.allList).append(r)}}),$(".entity").draggable({cursor:"move",cursorAt:{top:0,left:0},helper:"clone",start:function(e){t.dragActive=!0},stop:t.dropped})},appendContextEntity:function(e){var t=this;_(e.get("fields").models).each(function(n,r){var i={name:e.get("name"),cid:e.cid,attr:n.get("name"),type:n.get("type")};$(t.allList).append(_.template(Templates.tempLiSingleData,i))}),e.has("forms")&&_(e.get("forms").models).each(function(n){if(n.get("type")=="edit"){var r=_.template(Templates.createFormButton,{entity:e,form:n});$(t.allList).append(r)}}),$(".single-data").draggable({cursor:"move",cursorAt:{top:0,left:0},helper:"clone",start:function(e){t.dragActive=!0},stop:t.dropped})},appendElement:function(e){var t=this,n=document.createElement("li");n.className=e.get("className"),n.innerHTML='<span class="name">'+e.get("text")+"</span>",$(this.allList).append(n),$("."+e.get("className")).draggable({cursor:"move",cursorAt:{top:0,left:0},helper:function(t){return $(e.get("el")).css("position","fixed")},start:function(e){t.dragActive=!0},stop:t.dropped}),$(n).on("click",t.dropped)},sectionClicked:function(e){var t=String(e.target.id).replace("cont-","")+"-elements";$("#"+this.curId).hide(),$("#"+t).fadeIn(),this.curId=t,$(".selected").removeClass("selected"),$(e.target).addClass("selected")},setupSearch:function(){},dropped:function(e,t){var n=this,r={},i,s,o;this.dragActive=!1,e.type!="click"?(o=document.getElementById("page-wrapper").offsetLeft+100,i=Math.round((e.pageX-o)/GRID_WIDTH),s=Math.round((e.pageY-$(".page")[0].offsetTop-180)/GRID_HEIGHT),s<0&&(s=0),i<0&&(i=0),i+4>12&&(i=8)):(i=0,s=1,window.scrollTo(0,0)),r.layout={top:s,left:i};var u=e.target.className,a=e.target.id,f,l,c,h,p,d,v,m;m=u.replace(" ui-draggable",""),r=_.extend(r,themeState[m][0]),r.type=m,this.widgetsCollection.push(r)},determineType:function(e,t,n){var r=this}});return r});