define(["app/models/PageModel","app/collections/EntityCollection","app/collections/WidgetCollection","app/collections/ContainersCollection","app/collections/UrlsCollection","app/views/UrlView","app/views/SimpleModalView","editor/WidgetsManagerView","editor/WidgetClassPickerView","editor/WidgetEditorView","editor/DesignEditorView","app/designer-app/EditorLiteGalleryView","mixins/BackboneModal","../../libs/keymaster/keymaster.min"],function(e,t,n,r,i,s,o,u,a,f,l,c){var h=Backbone.View.extend({el:document.body,className:"sample",events:{"click #save":"save","click #settings":"showSettings","click #settings-cross":"hideSettings","click #deploy":"deploy","click .page":"clickedPage","click .url-bar":"clickedUrl"},initialize:function(){_.bindAll(this,"render","renderUrlBar","save","deployLocal","amendAppState","deploy","style","clickedPage","hideSettings","showSettings","getContextEntities","containerSelected","widgetSelected","keydown","clickedUrl");var i=themeState.pages[pageId];this.model=new e(i),this.entityCollection=new t,this.contextCollection=new t,this.containersCollection=new r,this.widgetsCollection=new n,this.galleryEditor=new c(this.widgetsCollection,this.containersCollection),this.widgetsManager=new u(this.widgetsCollection,this.containersCollection,null,i),this.widgetEditorView=new f(this.widgetsCollection),this.designEditor=new l(this.model,!0),this.urlModel=this.model.get("url"),this.containersCollection.on("selected",this.containerSelected),this.widgetsCollection.on("selected",this.widgetSelected),this.style(i),this.render(),$("#loading-gif").fadeOut().remove(),window.addEventListener("keydown",this.keydown),key("⌘+s, ctrl+s",this.save),key("⌘+shift+r, ctrl+shift+r",this.deployLocal)},render:function(){this.el.appendChild(this.designEditor.el),this.renderUrlBar()},renderUrlBar:function(){this.$el.find(".url-bar").html(this.urlModel.getUrlString())},save:function(e,t){$("#save").fadeOut().html("<span>Saving...</span>").fadeIn();var n=this.amendAppState();return $.ajax({type:"POST",url:"/theme/"+themeId+"/edit/",data:{uie_state:JSON.stringify(n)},complete:function(){iui.dontAskBeforeLeave()},success:function(){$("#save").html("<span>Saved</span>").fadeIn(),typeof t=="[object Function]"&&t(),setTimeout(function(){$("#save").html("<span>Save</span>").fadeIn()},3e3)},error:function(e,t){alert("Error saving! "+t),console.log(e)}}),!1},amendAppState:function(){var e=_.clone(themeState),t=_.clone(this.widgetsCollection);_(this.containersCollection.models).each(function(e){t.remove(e.get("container_info").get("uielements").models)});var n=t.toJSON()||[],r=this.containersCollection.toJSON()||[],i=_.union(n,r);return e.pages[pageId].uielements=i,e.pages[pageId].design_props=this.designEditor.model.toJSON().design_props||[],e},deploy:function(){var e=function(){$.ajax({type:"POST",url:"/app/"+appId+"/deploy/",complete:function(e){new o({text:'Your app is available at <a href="'+e.responseText+'">'+e.responseText+"</a>"})},dataType:"JSON"})};this.save(null,e)},deployLocal:function(){this.save(),$.ajax({type:"POST",url:"/app/"+appId+"/deploy/local/",complete:function(e){new o({text:'Your app is available at <a href="'+e.responseText+'">'+e.responseText+"</a>"})},dataType:"JSON"})},showSettings:function(){return $("#page-settings").animate({marginBottom:-10}),!1},style:function(e){var t=themeState.basecss;t=t.replace("body {",".page {"),t=t.replace("body{",".page {");var n=document.createElement("style");n.id="basecss",n.innerHTML=t,document.getElementsByTagName("head")[0].appendChild(n),_(themeState).each(function(e){_(e).each(function(e){if(e.attribs)return;var t=document.createElement("style"),n=e.tagName+"."+e.class_name+"{";n+=e.style,n+="}",t.innerHTML=n,this.styleTag=t,document.getElementsByTagName("head")[0].appendChild(t)})})},hideSettings:function(){return $("#page-settings").animate({marginBottom:"-100%"}),!1},getContextEntities:function(){var e=this,t=appState.pages[pageId].name,n=_.where(appState.urls,{page_name:t})[0];if(!n)return[];var r=[],i=_.filter(n.urlparts,function(e){return/\{\{([^\}]+)\}\}/g.exec(e)});i=_.map(i,function(e){return/\{\{([^\}]+)\}\}/g.exec(e)[1]}),_(i).each(function(t){e.contextCollection.add(e.entityCollection.where({name:t})[0])})},keydown:function(e){switch(e.keyCode){case 37:this.containersCollection.selectedEl?this.containersCollection.selectedEl.moveLeft():this.widgetsCollection.selectedEl.moveLeft(),e.preventDefault();break;case 38:this.containersCollection.selectedEl?this.containersCollection.selectedEl.moveUp():this.widgetsCollection.selectedEl.moveUp(),e.preventDefault();break;case 39:this.containersCollection.selectedEl?this.containersCollection.selectedEl.moveRight():this.widgetsCollection.selectedEl.moveRight(),e.preventDefault();break;case 40:this.containersCollection.selectedEl?this.containersCollection.selectedEl.moveDown():this.widgetsCollection.selectedEl.moveDown(),e.preventDefault();break;case 8:this.widgetsCollection.selectedEl&&this.widgetsCollection.removeSelected(e),this.containersCollection.selectedEl&&this.containersCollection.removeSelected(e);break;case 27:return this.widgetsCollection.selectedEl&&(this.widgetsCollection.selectedEl=null,this.widgetsCollection.unselectAll()),this.containersCollection.selectedEl&&(this.containersCollection.selectedEl=null,this.containersCollection.unselectAll()),!1}},clickedPage:function(){this.widgetsCollection.selectedEl&&(this.widgetsCollection.selectedEl=null,this.widgetsCollection.unselectAll()),this.containersCollection.selectedEl&&(this.containersCollection.selectedEl=null,this.containersCollection.unselectAll())},clickedUrl:function(){var e=new s(this.urlModel);e.onClose=this.renderUrlBar},containerSelected:function(e){this.widgetsCollection.unselectAll()},widgetSelected:function(e,t){this.containersCollection.unselectAll()}});return h});