define(["app/collections/WidgetCollection","editor/WidgetView","editor/RowEditorView","editor/RowGalleryView","mixins/BackboneModal","iui"],function(e,t,n,r){var i=Backbone.ModalView.extend({className:"list-editor-modal",width:920,height:600,padding:0,events:{"change .fields-to-display":"fieldsToDisplayChanged","click .belongs-to-user":"belongsToUserChanged","click .nmr-rows":"nmrRowsChanged","keydown #first-nmr, #last-nmr":"nmrRowsNumberChanged","change .sort-by":"sortByChanged","change .item-goes-to":"itemLinkChanged"},initialize:function(e,t,n){var r=this;_.bindAll(this,"render","renderConstants","fieldsToDisplayChanged","belongsToUserChanged","nmrRowsChanged","nmrRowsNumberChanged","addedWidget","resized","resizing","itemLinkChanged"),this.widgetModel=e,this.queryModel=t,this.rowModel=n,this.widgetsCollection=n.get("uielements"),this.entity=e.get("container_info").get("entity"),this.render()},render:function(){var e=this,t=document.createElement("div");t.className="list-query-view";var i={},s=5,o=5,u=0,a="",f="",l="";String(this.queryModel.get("numberOfRows")).indexOf("First")!=-1?(a="checked",s=this.queryModel.get("numberOfRows").replace("First-",""),s===""&&(s=5)):String(this.queryModel.get("numberOfRows")).indexOf("Last")!=-1?(f="checked",o=this.queryModel.get("numberOfRows").replace("Last-",""),o===""&&(o=5)):l="checked",i={rFirstNmr:s,rFirst:a,rLastNmr:o,rLast:f,rAll:l,rAllNmr:u,row:!0};var c=_.template(Templates.listQueryView,{entity:e.entity,query:e.queryModel,row:e.rowModel,c:i});t.innerHTML+=c;var h=document.createElement("div");h.className="list-editor-container";var p=new n(this.rowModel,this.entity);this.rowEditorView=p,h.appendChild(p.el);var d=document.createElement("div");d.className="list-gallery-container";var v=new r(this.rowModel,this.entity);return d.appendChild(v.el),this.el.appendChild(h),this.el.appendChild(t),this.el.appendChild(d),this},renderConstants:function(){var e=this;$(".constant-elements").remove();for(var t=0;t<2;t++){var n=_.clone(e.rowModel.get("layout"));n.attributes.width=6;var r=_.template(Templates.rowNode,{layout:n,uielements:e.widgetsCollection.models});$(".list-editor-container").append('<div class="constant-elements">'+r+"</div>")}},fieldsToDisplayChanged:function(e){var t=_.clone(this.queryModel.get("fieldsToDisplay"));e.target.checked?(t.push(e.target.value),this.addedWidget(e.target.id),t=_.uniq(t)):(this.rowEditorView.removedWidget(e.target.id),t=_.difference(t,e.target.value)),this.queryModel.set("fieldsToDisplay",t)},addedWidget:function(e){var t=String(e).replace("field-",""),n=this.entity.get("fields").get(t),r={};r.layout={top:0,left:0,width:2,height:4},r.field=n.cid;var i="texts";n.get("type")=="image"&&(i="images"),r=_.extend(r,uieState[i][0]),r.content="{{"+this.entity.get("name")+"."+n.get("name")+"}}",this.widgetsCollection.push(r)},belongsToUserChanged:function(e){if(e.target.checked){var t=e.target.value=="true"?!0:!1;this.queryModel.set("belongsToUser",t)}},nmrRowsChanged:function(e){if(e.target.checked){var t=e.target.value;t=="First"?t+="-"+iui.get("first-nmr").value:t=="Last"&&(t+="-"+iui.get("last-nmr").value),this.queryModel.set("numberOfRows",t)}},nmrRowsNumberChanged:function(e){var t="";e.target.id=="first-nmr"?(iui.get("first-rows").checked=!0,t="First-"+e.target.value):e.target.id=="last-nmr"&&(iui.get("last-rows").checked=!0,t="Last-"+e.target.value),this.queryModel.set("numberOfRows",t),e.stopPropagation()},sortByChanged:function(e){this.queryModel.set("sortAccordingTo",e.target.value)},resized:function(){this.rowWidget.style.width="",this.rowWidget.style.height="",this.rowWidget.className="editor-window container-wrapper ",this.rowWidget.className+="span"+this.rowModel.get("layout").get("width"),this.rowWidget.style.height=this.rowModel.get("layout").get("height")*GRID_HEIGHT+"px",this.rowWidget.style.position="relative"},resizing:function(e,t){var n=(t.size.height+2)/GRID_HEIGHT,r=(t.size.width+2)/GRID_WIDTH,i=Math.round((t.size.height+2)/GRID_HEIGHT),s=Math.round((t.size.width+2)/GRID_WIDTH);this.rowModel.get("layout").set("width",s),this.rowModel.get("layout").set("height",i)},itemLinkChanged:function(e){this.rowModel.set("goesTo","{{"+e.target.value+"}}")}});return i});