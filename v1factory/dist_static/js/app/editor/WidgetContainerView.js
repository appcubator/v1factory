define(["app/collections/WidgetCollection","editor/TableQueryView","editor/ListEditorView","editor/WidgetView","editor/SubWidgetView","app/views/FormEditorView","editor/editor-templates"],function(e,t,n,r,i,s){var o=r.extend({el:null,className:"container-create",tagName:"div",entity:null,type:null,events:{click:"select","click .delete":"remove",dblclick:"showDetails"},initialize:function(t){o.__super__.initialize.call(this,t);var n=this;_.bindAll(this,"render","reRender","placeWidget","placeFormElement","renderElements","showDetails","formEditorClosed");var r=new e;this.model.get("container_info").get("uielements").bind("add",this.placeWidget),this.model.get("container_info").has("query")&&this.model.get("container_info").get("query").bind("change",this.reRender),this.model.get("container_info").has("row")&&(this.model.get("container_info").get("row").get("layout").bind("change",this.reRender),this.rowBindings());if(this.model.get("container_info").has("form")){var i=this.model.get("container_info").get("entity").getFormWithName(this.model.get("container_info").get("form"));this.formModel=i,this.formModel.bind("change",this.reRender),this.formModel.get("fields").bind("remove",this.reRender),this.formModel.get("fields").bind("add",this.reRender),_(this.formModel.get("fields").models).each(function(e){e.bind("change",n.reRender)})}this.render(),this.resizableAndDraggable(),this.renderElements()},rowBindings:function(){var e=this;_(e.model.get("container_info").get("row").get("uielements").models).each(function(t){t.off(),t.get("layout").off("change",e.reRender),t.bind("change",e.reRender),t.get("layout").bind("change",e.reRender)})},render:function(){var e=this;this.el.innerHTML="";var t=this.model.get("layout").get("width"),n=this.model.get("layout").get("height");this.setTop(GRID_HEIGHT*this.model.get("layout").get("top")),this.setLeft(GRID_WIDTH*this.model.get("layout").get("left")),this.setHeight(n*GRID_HEIGHT),this.el.className+=" widget-wrapper span"+t;if(this.model.get("container_info").get("action")=="table-gal"){var r=document.createElement("div");r.innerHTML=_.template(Templates.tableNode,this.model.get("container_info").get("query").attributes),this.el.appendChild(r)}if(this.model.get("container_info").get("action")=="show"){var i=document.createElement("div"),s=this.model.get("container_info").get("row");i.innerHTML=_.template(Templates.listNode,{layout:s.get("layout"),uielements:s.get("uielements").models,isListOrGrid:s.get("isListOrGrid")}),this.el.appendChild(i)}return this},reRender:function(){$(this.el).resizable("destroy"),$(this.el).draggable("destroy"),this.model.get("container_info").has("row")&&this.rowBindings(),this.render(),this.resizableAndDraggable(),this.renderElements()},placeWidget:function(e,t){var n=new i(e);this.el.appendChild(n.el),e.get("layout").bind("change",this.reRender)},placeFormElement:function(e){var t=uieState.textInputs[0].class_name,n=_.template(Templates.fieldNode,{field:e,inpClass:t});$(this.el).append(n)},renderElements:function(){var e=this;_(this.model.get("container_info").get("uielements").models).each(function(t){e.placeWidget(t)}),this.model.get("container_info").has("form")&&_(this.formModel.get("fields").models).each(function(t){e.placeFormElement(t)})},showDetails:function(){this.model.get("container_info").get("action")==="table-gal"&&new t(this.model,this.model.get("container_info").get("query")),this.model.get("container_info").has("form")&&new s(this.formModel,this.model.get("container_info").get("entity"),this.formEditorClosed),this.model.get("container_info").has("row")&&new n(this.model,this.model.get("container_info").get("query"),this.model.get("container_info").get("row"))},formEditorClosed:function(){var e=this,t,n;n=this.model.get("container_info").get("entity").get("name");if(n=="User"){var r=_.findWhere(appState.users.forms,{name:e.formModel.get("name")});t=_.indexOf(appState.users.forms,r),r=this.formModel.toJSON(),appState.users.forms[t]=r}else{var i=_.findWhere(appState.entities,{name:n});indexEnt=_.indexOf(appState.entities,i);var s=_.findWhere(appState.entities[indexEnt],i);t=_.indexOf(appState.entities[indexEnt].forms,s),appState.entities[indexEnt].forms[t]=this.formModel.toJSON()}}});return o});