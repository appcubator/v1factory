define(["app/models/PageModel","app/models/UserEntityModel","app/collections/EntityCollection","app/collections/WidgetCollection","app/collections/ContainersCollection","app/collections/UrlsCollection","app/views/UrlView","app/views/SimpleModalView","editor/WidgetsManagerView","editor/WidgetClassPickerView","editor/WidgetEditorView","editor/DesignEditorView","editor/EditorGalleryView","editor/PageStylePicker","editor/NavbarEditorView","mixins/BackboneModal","../../libs/keymaster/keymaster.min"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d){var v=Backbone.View.extend({el:document.body,className:"sample",events:{"click #save":"save","click #settings":"showSettings","click #settings-cross":"hideSettings","click #deploy":"deploy","click .page":"clickedPage","click .url-bar":"clickedUrl"},initialize:function(){_.bindAll(this,"render","copy","paste","renderUrlBar","save","deployLocal","amendAppState","deploy","style","clickedPage","hideSettings","showSettings","getContextEntities","containerSelected","widgetSelected","keydown","clickedUrl");var s=appState.pages[pageId];g_entityCollection=new n(appState.entities),g_contextCollection=new n,g_userModel=new t(appState.users),this.model=new e(s),this.containersCollection=new i,this.widgetsCollection=new r,this.galleryEditor=new h(this.widgetsCollection,this.containersCollection),this.widgetsManager=new a(this.widgetsCollection,this.containersCollection,s),this.widgetEditorView=new l(this.widgetsCollection,this.containersCollection),this.navbarEditor=new d(this.model.get("navbar")),this.urlModel=this.model.get("url"),this.containersCollection.on("selected",this.containerSelected),this.widgetsCollection.on("selected",this.widgetSelected),this.getContextEntities(),this.render(),s.uielements.length||new p(this.widgetsCollection),window.addEventListener("keydown",this.keydown),key("⌘+s, ctrl+s",this.save),key("⌘+c, ctrl+c",this.copy),key("⌘+v, ctrl+v",this.paste),key("⌘+shift+d, ctrl+shift+d",this.deployLocal),$("#loading-gif").fadeOut().remove()},render:function(){this.style(),iui.get("page-list").innerHTML+="<li>"+appState.pages[pageId].name+"</li>",_(appState.pages).each(function(e,t){if(pageId==t)return;iui.get("page-list").innerHTML+='<li><a href="/app/'+appId+"/pages/editor/"+t+'">'+e.name+"</a></li>"}),this.renderUrlBar()},renderUrlBar:function(){this.$el.find(".url-bar").html(this.urlModel.getUrlString())},save:function(e){$("#save").fadeOut().html("<span>Saving...</span>").fadeIn();var t=this.amendAppState();return $.ajax({type:"POST",url:"/app/"+appId+"/state/",data:JSON.stringify(t),complete:function(){iui.dontAskBeforeLeave()},success:function(){$("#save").html("<span>Saved</span>").fadeIn(),typeof e!="undefined"&&typeof e=="function"&&e(),setTimeout(function(){$("#save").html("<span>Save</span>").fadeIn()},3e3)},error:function(e,t){alert("Error saving! "+t),console.log(e)}}),!1},copy:function(e){this.widgetsManager.copy()},paste:function(e){this.widgetsManager.paste()&&e.stopPropagation()},amendAppState:function(){var e=_.clone(appState),t=_.clone(this.widgetsCollection);_(this.containersCollection.models).each(function(e){t.remove(e.get("container_info").get("uielements").models)});var n=t.toJSON()||[],r=this.containersCollection.toJSON()||[],i=_.union(n,r);return e.pages[pageId].uielements=i,e.pages[pageId].navbar=this.model.get("navbar").toJSON(),e.entities=g_entityCollection.toJSON(),e.users=g_userModel.toJSON(),e},deploy:function(){var e=this,t=function(){$.ajax({type:"POST",url:"/app/"+appId+"/deploy/",complete:function(t){new u({text:'Your app is available at <a href="'+t.responseText+e.urlModel.getAppendixString()+'">'+t.responseText+e.urlModel.getAppendixString()+"</a>",img:"happy_engineer.png"})},dataType:"JSON"})};this.save(t)},deployLocal:function(){this.save(),$.ajax({type:"POST",url:"/app/"+appId+"/deploy/local/",complete:function(e){new u({text:'Your app is available at <a href="'+e.responseText+'">'+e.responseText+"</a>"})},dataType:"JSON"})},showSettings:function(){return $("#page-settings").animate({marginBottom:-10}),!1},style:function(){},hideSettings:function(){return $("#page-settings").animate({marginBottom:"-100%"}),!1},getContextEntities:function(){var e=this,t=[],n=_.filter(e.model.get("url").get("urlparts"),function(e){return/\{\{([^\}]+)\}\}/g.exec(e)});n=_.map(n,function(e){return/\{\{([^\}]+)\}\}/g.exec(e)[1]}),_(n).each(function(e){g_contextCollection.add(g_entityCollection.getEntityWithName(e))})},keydown:function(e){switch(e.keyCode){case 37:this.containersCollection.selectedEl?this.containersCollection.selectedEl.moveLeft():this.widgetsCollection.selectedEl&&this.widgetsCollection.selectedEl.moveLeft(),e.preventDefault();break;case 38:this.containersCollection.selectedEl?this.containersCollection.selectedEl.moveUp():this.widgetsCollection.selectedEl&&this.widgetsCollection.selectedEl.moveUp(),e.preventDefault();break;case 39:this.containersCollection.selectedEl?this.containersCollection.selectedEl.moveRight():this.widgetsCollection.selectedEl&&this.widgetsCollection.selectedEl.moveRight(),e.preventDefault();break;case 40:this.containersCollection.selectedEl?this.containersCollection.selectedEl.moveDown():this.widgetsCollection.selectedEl&&this.widgetsCollection.selectedEl.moveDown(),e.preventDefault();break;case 8:this.widgetsCollection.selectedEl&&this.widgetsCollection.removeSelected(e),this.containersCollection.selectedEl&&this.containersCollection.removeSelected(e);break;case 27:return this.widgetsCollection.selectedEl&&(this.widgetsCollection.selectedEl=null,this.widgetsCollection.unselectAll()),this.containersCollection.selectedEl&&(this.containersCollection.selectedEl=null,this.containersCollection.unselectAll()),!1}},clickedPage:function(){this.widgetsCollection.selectedEl&&(this.widgetsCollection.selectedEl=null,this.widgetsCollection.unselectAll()),this.containersCollection.selectedEl&&(this.containersCollection.selectedEl=null,this.containersCollection.unselectAll())},clickedUrl:function(){var e=new o(this.urlModel);e.onClose=this.renderUrlBar},containerSelected:function(e){this.widgetsCollection.unselectAll()},widgetSelected:function(e,t){this.containersCollection.unselectAll()}});return v});