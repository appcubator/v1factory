define(["app/collections/ElementCollection","app/models/UserEntityModel","backbone","iui"],function(e,t,n){var r=n.View.extend({el:iui.get("top-panel-bb"),allList:iui.get("all-list"),elementsList:iui.get("interface-list"),dataList:iui.get("entities-list"),userList:iui.get("user-list"),widgetsCollection:null,containersCollection:null,curId:"all-elements",dragActive:!1,events:{"click .header":"sectionClicked"},initialize:function(t,n){_.bindAll(this,"render","appendEntity","appendContextEntity","appendElement","appendUserElements","dropped","setupSearch"),this.elementsCollection=new e(defaultElements),this.widgetsCollection=t,this.containersCollection=n,this.userModel=g_userModel,g_entityCollection.bind("add",this.appendEntity,this),g_contextCollection.bind("add",this.appendContextEntity,this),this.elementsCollection.bind("add",this.appendElement,this),this.render()},render:function(){var e=this;return this.appendUserElements(),_(g_entityCollection.models).each(function(t){e.appendEntity(t)}),_(g_contextCollection.models).each(function(t){e.appendContextEntity(t)}),_(e.elementsCollection.models).each(function(t){e.appendElement(t)}),this},appendUserElements:function(){var e=this;this.userModel.has("forms")&&_(this.userModel.get("forms").models).each(function(t){var n=_.template(Templates.formButton,{entity:{cid:"user"},form:t});$(e.allList).append(n)});if(appState.users.facebook){var t='<li id="entity-user" class="facebook entity"><span class="name">Facebook Login Button</span></li>';$(e.allList).append(t)}if(appState.users.twitter){var n='<li id="entity-user" class="twitter entity"><span class="name"> Twitter Button</span></li>';$(e.allList).append(n)}if(appState.users.linkedin){var r='<li id="entity-user" class="linkedin entity"><span class="name">LinkedIn Login Button</span></li>';$(e.allList).append(r)}this.appendContextEntity(this.userModel);var i={name:"User",cid:"user"};$(this.allList).append(_.template(Templates.tempLiTable,i)),$(".entity").draggable({cursor:"move",cursorAt:{top:0,left:0},helper:"clone",start:function(t){e.dragActive=!0},stop:e.dropped}),_(appState.users.fields).each(function(t){var n={name:"User",attr:t.name,type:t.type};$(e.allList).append(_.template(Templates.tempLi,n))}),$(".single-data").draggable({cursor:"move",cursorAt:{top:0,left:0},helper:"clone",start:function(t){e.dragActive=!0},stop:e.dropped})},appendEntity:function(e){var t=this,n={name:e.get("name"),cid:e.cid};$(this.allList).append(_.template(Templates.tempLiEntity,n)),$(this.allList).append(_.template(Templates.tempLiTable,n)),e.has("forms")&&_(e.get("forms").models).each(function(n){if(n.get("action")=="create"){var r=_.template(Templates.createFormButton,{entity:e,form:n});$(t.allList).append(r)}}),$(".entity").draggable({cursor:"move",cursorAt:{top:0,left:0},helper:"clone",start:function(e){t.dragActive=!0},stop:t.dropped})},appendContextEntity:function(e){var t=this;_(e.get("fields").models).each(function(n,r){var i={name:e.get("name"),cid:e.cid,attr:n.get("name"),type:n.get("type")};$(t.allList).append(_.template(Templates.tempLiSingleData,i))}),e.has("forms")&&_(e.get("forms").models).each(function(n){if(n.get("type")=="edit"){var r=_.template(Templates.createFormButton,{entity:e,form:n});$(t.allList).append(r)}}),$(".single-data").draggable({cursor:"move",cursorAt:{top:0,left:0},helper:"clone",start:function(e){t.dragActive=!0},stop:t.dropped})},appendElement:function(e){var t=this,n=document.createElement("li");n.className=e.get("className"),n.innerHTML='<span class="name">'+e.get("text")+"</span>",$(this.allList).append(n),$("."+e.get("className")).draggable({cursor:"move",cursorAt:{top:0,left:0},helper:function(t){return $(e.get("el")).css("position","fixed")},start:function(e){t.dragActive=!0},stop:t.dropped}),$(n).on("click",t.dropped)},sectionClicked:function(e){var t=String(e.target.id).replace("cont-","")+"-elements";$("#"+this.curId).hide(),$("#"+t).fadeIn(),this.curId=t,$(".selected").removeClass("selected"),$(e.target).addClass("selected")},setupSearch:function(){},dropped:function(e,n){var r=this,i={},s,o,u;this.dragActive=!1,e.type!="click"?(u=document.getElementById("page-wrapper").offsetLeft+100,s=Math.round((e.pageX-u)/GRID_WIDTH),o=Math.round((e.pageY-$(".page")[0].offsetTop-180)/GRID_HEIGHT),o<0&&(o=0),s<0&&(s=0),s+4>12&&(s=8)):(s=0,o=1,window.scrollTo(0,0)),i.layout={top:o,left:s};var a=e.target.className,f=e.target.id,l,c,h,p,d,v,m;if(/(entity)/.exec(a))l=String(f).split("-"),c=l[1],h=l[2],p=a.split(" ")[0],c==="user"?(d=g_userModel,v=d.get("forms").get(h)):(d=g_entityCollection.get(c),v=d.get("forms").get(h)),i.container_info={},i.container_info.entity=d,i.container_info.action=p,v&&(i.container_info.form="{{"+v.get("name")+"}}"),this.containersCollection.push(i);else if(/(single-data)/.exec(a)){f=String(f).replace("entity-","");var g=f.split("-")[0];g===this.userModel.cid?(d=new t(appState.users),content="{{CurrentUser."+m+"}}"):(d=this.entitiesCollection.get(g),content="{{page."+d.get("name")+"."+m+"}}"),m=f.split("-")[1],i=_.extend(i,uieState.texts[0]),i.content=content,this.widgetsCollection.push(i)}else{var y;y=a.replace(" ui-draggable",""),console.log(y),console.log(uieState),i=_.extend(i,uieState[y][0]),i.type=y,this.widgetsCollection.push(i)}},determineType:function(e,t,n){var r=this}});return r});