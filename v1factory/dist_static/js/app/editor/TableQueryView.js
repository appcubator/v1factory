define(["mixins/BackboneModal","iui"],function(){var e=Backbone.ModalView.extend({className:"query-modal modal",events:{"change .fields-to-display":"fieldsToDisplayChanged","click .belongs-to-user":"belongsToUserChanged","click .nmr-rows":"nmrRowsChanged","keydown #first-nmr, #last-nmr":"nmrRowsNumberChanged","change .sort-by":"sortByChanged"},initialize:function(e,t){_.bindAll(this,"fieldsToDisplayChanged","belongsToUserChanged","nmrRowsChanged","nmrRowsNumberChanged","getNLdescription","changeDescription"),this.widgetModel=e,this.model=t,this.entity=e.get("container_info").get("entity"),this.render(),this.model.bind("change",this.changeDescription,this)},render:function(){var e=this,t={},n=5,r=5,i=0,s="",o="",u="";String(this.model.get("numberOfRows")).indexOf("First")!=-1?(s="checked",n=this.model.get("numberOfRows").replace("First-",""),n===""&&(n=5)):String(this.model.get("numberOfRows")).indexOf("Last")!=-1?(o="checked",r=this.model.get("numberOfRows").replace("Last-",""),r===""&&(r=5)):u="checked",t={rFirstNmr:n,rFirst:s,rLastNmr:r,rLast:o,rAll:u,rAllNmr:i,nLang:e.getNLdescription()};var a=_.template(Templates.queryView,{entity:e.entity,query:e.model,c:t});return a+='<input type="submit" class="btn offsetr1 pull-right" value="Done"><div class="hoff1 span10"></div>',this.el.innerHTML=a,this},changeDescription:function(){iui.get("query-description").innerHTML=this.getNLdescription()},fieldsToDisplayChanged:function(e){var t=_.clone(this.model.get("fieldsToDisplay"));e.target.checked?(t.push(e.target.value),t=_.uniq(t)):t=_.difference(t,e.target.value),this.model.set("fieldsToDisplay",t)},belongsToUserChanged:function(e){if(e.target.checked){var t=e.target.value=="true"?!0:!1;this.model.set("belongsToUser",t)}},nmrRowsChanged:function(e){if(e.target.checked){var t=e.target.value;t=="First"?t+="-"+iui.get("first-nmr").value:t=="Last"&&(t+="-"+iui.get("last-nmr").value),this.model.set("numberOfRows",t)}},nmrRowsNumberChanged:function(e){var t="";e.target.id=="first-nmr"?(iui.get("first-rows").checked=!0,t="First-"+e.target.value):e.target.id=="last-nmr"&&(iui.get("last-rows").checked=!0,t="Last-"+e.target.value),this.model.set("numberOfRows",t),e.stopPropagation()},sortByChanged:function(e){this.model.set("sortAccordingTo",e.target.value)},getNLdescription:function(){var e=this,t="This table shows ";return e.model.get("fieldsToDisplay").length===0?(t+="no data. Please choose the fields from below.",t):(_(e.model.get("fieldsToDisplay")).each(function(n,r){if(e.model.get("fieldsToDisplay").length==1)t+=n+" ";else{if(e.model.get("fieldsToDisplay").length>1&&r==e.model.get("fieldsToDisplay").length-1){t+="and "+n;return}t+=n+", "}}),t+=" of",this.model.get("numberOfRows")===0?t+=" all "+e.model.entity.get("name")+"s":this.model.get("numberOfRows")==1?t+=" a "+e.model.entity.get("name"):t+=" "+String(e.model.get("numberOfRows")).replace("-"," ").toLowerCase()+" "+e.model.entity.get("name")+"s",t+=" sorted "+String(e.model.get("sortAccordingTo")).replace("-"," ").toLowerCase()+".",t)}});return e});