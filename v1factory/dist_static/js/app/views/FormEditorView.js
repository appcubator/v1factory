define(["app/models/FormFieldModel","app/templates/FormEditorTemplates","mixins/BackboneModal","jquery-ui"],function(e){var t=Backbone.ModalView.extend({tagName:"div",width:882,height:500,padding:0,className:"form-editor",events:{"change  .field-name-box":"fieldBoxChanged","click   .field-li-item":"clickedField","change  .field-type":"changedFieldType","keydown .field-placeholder-input":"changedPlaceholder","keydown input.field-label-input":"changedLabel","keyup   .field-placeholder-input":"changedPlaceholder","keyup   input.field-label-input":"changedLabel","keyup  .options-input":"changedOptions","change .goto":"changedGoto","change .form-type-select":"changedFormAction","change .belongs-to":"changedBelongsTo"},initialize:function(e,t,n){_.bindAll(this,"render","fieldBoxChanged","fieldAdded","fieldRemoved","changedGoto","selectedNew","changedFieldType","renderField","reRenderFields","clickedField","changedPlaceholder","changedLabel","changedOrder","changedFormAction","findPossibleOwners","changedBelongsTo"),this.model=e,this.entity=t,this.model.get("fields").bind("add",this.fieldAdded),this.model.get("fields").bind("remove",this.fieldRemoved),this.model.bind("change:action",this.reRenderFields),this.render(),this.model.get("fields").models.length>0&&this.selectedNew(_.last(this.model.get("fields").models)),this.callback=n},render:function(e){var t=this,n={};n.form=t.model,n.entity=t.entity,n.pages=appState.pages,n.possibleEntities=this.findPossibleOwners();var r=_.template(FormEditorTemplates.template,n);return this.el.innerHTML=r,$(".form-fields-list").sortable({stop:this.changedOrder}),this},reRenderFields:function(){var e=this;_(e.model.get("fields").models).each(function(t){var n="";e.model.get("action")=="edit"&&(n="{{"+e.entity.get("name")+"_"+t.get("name")+"}}"),e.$el.find("#field-"+t.cid).html("<label>"+t.get("label")+"<br>"+_.template(FieldTypes[t.get("displayType")],{field:t,value:n})+"</label>")})},fieldBoxChanged:function(t){var n=this;if(t.target.checked){var r=t.target.id.replace("field-",""),i=n.entity.get("fields").get(r),s=new e({name:t.target.value,displayType:"single-line-text",type:i.get("type")});i.get("type")=="email"&&s.set("displayType","email-text"),i.get("type")=="image"&&s.set("displayType","image-uploader"),i.get("type")=="date"&&s.set("displayType","date-picker"),this.model.get("fields").add(s)}else{var o=this.model.get("fields").where({name:t.target.value});this.model.get("fields").remove(o)}},fieldAdded:function(e){var t=this,n=_.template(FormEditorTemplates.field,{field:e,form:t.model,entity:t.entity});this.$el.find(".form-fields-list").append(n),this.selectedNew(e)},fieldRemoved:function(e){this.$el.find("#field-"+e.cid).remove()},selectedNew:function(e){var t=_.template(FormEditorTemplates.details,{field:e});this.selected=e,this.selected.bind("change",this.renderField),this.$el.find(".details-panel").html(t),this.$el.find(".selected").removeClass("selected"),this.$el.find("#field-"+e.cid).addClass("selected")},clickedField:function(e){e.preventDefault();var t=String(e.target.id||e.target.parentNode.id||e.target.parentNode.parentNode.id).replace("field-",""),n=this.model.get("fields").get(t);this.selectedNew(n)},renderField:function(){var e=this,t=this.selected,n="";e.model.get("action")=="edit"&&(n="{{"+e.entity.get("name")+"_"+t.get("name")+"}}"),this.$el.find("#field-"+t.cid).html("<label>"+t.get("label")+"<br>"+_.template(FieldTypes[t.get("displayType")],{field:t,value:n})+"</label>")},changedFieldType:function(e){e.preventDefault();if(e.target.checked){var t=e.target.value;this.selected.set("displayType",t);var n=this.$el.find(".options-input").val()||"";this.$el.find(".options-input-area").remove();if(t=="option-boxes"||t=="dropdown")this.selected.set("options",n.split(",")),this.$el.find(".field-types").append('<span class="options-input-area">Options<br><input class="options-input" placeholder="E.g. Cars,Birds,Trains..." type="text" value="'+n+'"></span>')}},changedPlaceholder:function(e){this.selected.set("placeholder",e.target.value),e.stopPropagation()},changedLabel:function(e){this.selected.set("label",e.target.value),e.stopPropagation()},changedOptions:function(e){var t=String(this.$el.find(".options-input").val()).split(",");this.selected.set("options",t),e.stopPropagation()},changedOrder:function(e,t){var n=$(".form-fields-list").sortable("toArray");for(var r=0;r<n.length;r++){var i=n[r].replace("field-",""),s=this.model.get("fields").get(i);this.model.get("fields").remove(s),this.model.get("fields").push(s)}},changedGoto:function(e){var t="{{"+$(e.target).val()+"}}";this.model.set("goto",t)},changedFormAction:function(e){this.model.set("action",e.target.value)},changedBelongsTo:function(e){this.model.set("belongsTo",e.target.value)},findPossibleOwners:function(){var e=this,t=[];return _(appState.entities).each(function(n){_(n.fields).each(function(r){if(r.type=="{{"+e.entity.get("name")+"}}"){var i="{{"+n.name+"."+r.name+"}}";t.push(i)}})}),t}});return t});