//     keymaster.js
//     (c) 2011-2012 Thomas Fuchs
//     keymaster.js may be freely distributed under the MIT license.

(function(e){function t(e,t){var n=e.length;while(n--)if(e[n]===t)return n;return-1}function n(e,n){var r,i,o,u,a;r=e.keyCode,t(w,r)==-1&&w.push(r);if(r==93||r==224)r=91;if(r in m){m[r]=!0;for(o in y)y[o]==r&&(s[o]=!0);return}if(!s.filter.call(this,e))return;if(!(r in v))return;for(u=0;u<v[r].length;u++){i=v[r][u];if(i.scope==n||i.scope=="all"){a=i.mods.length>0;for(o in m)if(!m[o]&&t(i.mods,+o)>-1||m[o]&&t(i.mods,+o)==-1)a=!1;(i.mods.length==0&&!m[16]&&!m[18]&&!m[17]&&!m[91]||a)&&i.method(e,i)===!1&&(e.preventDefault?e.preventDefault():e.returnValue=!1,e.stopPropagation&&e.stopPropagation(),e.cancelBubble&&(e.cancelBubble=!0))}}}function r(e){var n=e.keyCode,r,i=t(w,n);i>=0&&w.splice(i,1);if(n==93||n==224)n=91;if(n in m){m[n]=!1;for(r in y)y[r]==n&&(s[r]=!1)}}function i(){for(d in m)m[d]=!1;for(d in y)s[d]=!1}function s(e,t,n){var r,i,s,o;n===undefined&&(n=t,t="all"),e=e.replace(/\s/g,""),r=e.split(","),r[r.length-1]==""&&(r[r.length-2]+=",");for(s=0;s<r.length;s++){i=[],e=r[s].split("+");if(e.length>1){i=e.slice(0,e.length-1);for(o=0;o<i.length;o++)i[o]=y[i[o]];e=[e[e.length-1]]}e=e[0],e=b[e]||e.toUpperCase().charCodeAt(0),e in v||(v[e]=[]),v[e].push({shortcut:r[s],scope:t,method:n,key:r[s],mods:i})}}function o(e){if(typeof e=="string"){if(e.length!=1)return!1;e=e.toUpperCase().charCodeAt(0)}return t(w,e)!=-1}function u(){return w}function a(e){var t=(e.target||e.srcElement).tagName;return t!="INPUT"&&t!="SELECT"&&t!="TEXTAREA"}function f(e){g=e||"all"}function l(){return g||"all"}function c(e){var t,n,r;for(t in v){n=v[t];for(r=0;r<n.length;)n[r].scope===e?n.splice(r,1):r++}}function h(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,function(){n(window.event)})}function p(){var t=e.key;return e.key=E,t}var d,v={},m={16:!1,18:!1,17:!1,91:!1},g="all",y={"⇧":16,shift:16,"⌥":18,alt:18,option:18,"⌃":17,ctrl:17,control:17,"⌘":91,command:91},b={backspace:8,tab:9,clear:12,enter:13,"return":13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,del:46,"delete":46,home:36,end:35,pageup:33,pagedown:34,",":188,".":190,"/":191,"`":192,"-":189,"=":187,";":186,"'":222,"[":219,"]":221,"\\":220},w=[];for(d=1;d<20;d++)y["f"+d]=111+d;for(d in y)s[d]=!1;h(document,"keydown",function(e){n(e,g)}),h(document,"keyup",r),h(window,"focus",i);var E=e.key;e.key=s,e.key.setScope=f,e.key.getScope=l,e.key.deleteScope=c,e.key.filter=a,e.key.isPressed=o,e.key.getPressedKeyCodes=u,e.key.noConflict=p,typeof module!="undefined"&&(module.exports=key)})(this);