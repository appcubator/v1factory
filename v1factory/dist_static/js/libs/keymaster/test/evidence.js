/*  evidence.js, version 0.6
 *
 *  Copyright (c) 2009 Tobie Langel (http://tobielangel.com)
 *
 *  evidence.js is freely distributable under the terms of an MIT-style license.
 *--------------------------------------------------------------------------*/

(function(e){function r(){p.extend.apply(p,arguments)}function i(){return e.Evidence=t,r}function o(){return(e.location||"").toString().replace(s,"$1")}function u(e,t){function n(){}return n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e,e}function a(t,n){"setTimeout"in e?window.setTimeout(function(){t.call(n)},10):t.call(n)}function f(e){this.message=e}function l(e,t,n){this.message=e,this.template=t||"",this.args=n}function c(e,t,n){this.message=e.replace(/%/g,"%%"),this.template=t||"",this.args=n}function p(e){this._methodName=e,this.name=e}function d(e,t){this.name=e,this._tests=[],t&&this.push.apply(this,t)}function v(){}function g(){}function y(){e.console&&e.console.log?this.logger=E:Object.prototype.toString.call(e.environment)==="[object Environment]"&&e.print?this.logger=x:this.logger=S,this.autoRun=!0,this.verbosity=E.INFO,this.runner=T}function b(){this.testCount=0,this.assertionCount=0,this.skipCount=0,this.skips=[],this.failureCount=0,this.failures=[],this.errors=[],this.errorCount=0,this.testCount=0}function E(e){typeof e!="undefined"&&(this.level=e)}function S(e){E.call(this,e)}function x(e){E.call(this,e)}function T(e){v.call(this),this.logger=e}function N(e){b.call(this),this.logger=e}var t=e.Evidence,n=e.onload;r.noConflict=i,r.VERSION="0.6";var s=/.*?\/(\w+\.html)(.*)/;f.displayName="AssertionSkippedError",function(e){e.name="AssertionSkippedError"}(f.prototype),r.AssertionSkippedError=f,l.displayName="AssertionFailedError",function(e){e.name="AssertionFailedError"}(l.prototype),r.AssertionFailedError=l,c.displayName="AssertionMessage",function(e){function t(){return C.printf(this.message+this.template,this.args)}e.toString=t}(c.prototype),r.AssertionMessage=c;var h=function(){function e(e,t,n){if(!e){var r=Array.prototype.slice.call(arguments,3);throw new l(t,n,r)}this.addAssertion()}function t(e){throw new f(e||"Skipped!")}function n(e){this._assertExpression(!1,e||"Flunked!")}function r(e,t){this._assertExpression(!!e,t||"Failed assertion.","Expected %o to evaluate to true.",e)}function i(e,t){this._assertExpression(!e,t||"Failed refutation.","Expected %o to evaluate to false.",e)}function s(e,t){this._assertExpression(e===!0,t||"Failed assertion.","Expected %o to be true.",e)}function o(e,t){this._assertExpression(e!==!0,t||"Failed refutation.","Expected %o to not be true.",e)}function u(e,t){this._assertExpression(e===null,t||"Failed assertion.","Expected %o to be null.",e)}function a(e,t){this._assertExpression(e!==null,t||"Failed refutation.","Expected %o to not be null.",e)}function c(e,t){this._assertExpression(typeof e=="undefined",t||"Failed assertion.","Expected %o to be undefined.",e)}function h(e,t){this._assertExpression(typeof e!="undefined",t||"Failed refutation.","Expected %o to not be undefined.",e)}function p(e,t){this._assertExpression(e===!1,t||"Failed assertion.","Expected %o to be false.",e)}function d(e,t){this._assertExpression(e!==!1,t||"Failed refutation.","Expected %o to not be false.",e)}function v(e,t,n){this._assertExpression(e==t,n||"Failed assertion.","Expected %o to be == to %o.",t,e)}function m(e,t,n){this._assertExpression(e!=t,n||"Failed refutation.","Expected %o to be != to %o.",t,e)}function g(e,t,n){this._assertExpression(e===t,n||"Failed assertion.","Expected %o to be === to %o.",t,e)}function y(e,t,n){this._assertExpression(e!==t,n||"Failed refutation.","Expected %o to be !== to %o.",t,e)}function b(e,t,n){this._assertExpression(e in t,n||"Failed assertion.",'Expected "%s" to be a property of %o.',e,t)}function w(e,t,n){this._assertExpression(!(e in t),n||"Failed refutation.",'Expected "%s" to not be a property of %o.',e,t)}return{_assertExpression:e,skip:t,assert:r,refute:i,assertNot:i,assertTrue:s,assertNull:u,assertUndefined:c,assertFalse:p,assertIdentical:g,refuteIdentical:y,assertEqual:v,refuteEqual:m,assertIn:b,refuteIn:w,fail:n,flunk:n}}();r.Assertions=h,function(){function e(t,n){function r(e){p.call(this,e)}n||(n=t,t=o()),u(r,this),r.displayName=t,r.extend=e;for(var i in n)r.prototype[i]=n[i];return p.subclasses.push(r),r}function t(){}t.prototype=h,p.prototype=new t,p.constructor=p,p.displayName="TestCase",p.extend=e,p.subclasses=[],p.defaultTimeout=1e4}(),function(t){function n(e){e&&(this._result=e);try{this._nextAssertions?(this._result.restartTest(this),this._nextAssertions(this)):(this._result.startTest(this),this.setUp(this),this[this._methodName](this))}catch(t){this._filterException(t)}finally{if(this._paused)this._result.pauseTest(this);else try{this.tearDown(this)}catch(t){this._filterException(t)}finally{this._nextAssertions=null,this._result.stopTest(this),a(function(){this.parent.next()},this)}}}function r(e){var t=e.name;switch(t){case"AssertionFailedError":this._result.addFailure(this,e);break;case"AssertionSkippedError":this._result.addSkip(this,e);break;default:this._result.addError(this,e)}}function i(t){this._paused=!0;var n=this;t&&(this._nextAssertions=t),n._timeoutId=e.setTimeout(function(){n.resume(function(){n.fail("Test timed out. Testing was not resumed after being paused.")})},p.defaultTimeout)}function s(t){this._paused&&(this._paused=!1,e.clearTimeout(this._timeoutId),t&&(this._nextAssertions=t),this.run())}function o(){return 1}function u(){return this.constructor.displayName+"#"+this.name}function f(){this._result.addAssertion()}t.run=n,t.addAssertion=f,t._filterException=r,t.pause=i,t.resume=s,t.size=o,t.toString=u,t.setUp=function(){},t.tearDown=function(){}}(p.prototype),r.TestCase=p,d.displayName="TestSuite",function(e){function t(e){return this._index=0,this._result=e,e.startSuite(this),this.next(),e}function n(){var e=this._tests[this._index];e?(this._index++,e.run(this._result)):(this._result.stopSuite(this),this.parent?this.parent.next():this._result.stop(new Date))}function r(){for(var e=0,t=arguments.length;e<t;e++){var n=arguments[e];n.parent=this,this._tests.push(n)}}function i(e){e.parent=this,this._tests.push(e)}function s(e){for(var t=0,n=e.length;t<n;t++)this.addTest(e[t])}function o(){var e=this._tests,t=e.length,n=0;for(var r=0;r<t;r++)n+=e[r].size();return n}function u(){return this.size()===0}function a(){return this.name}e.run=t,e.next=n,e.push=r,e.size=o,e.isEmpty=u,e.toString=a}(d.prototype),r.TestSuite=d,v.displayName="TestRunner",function(e){function t(e){e.parent=null;var t=this._makeResult();return t.start(new Date),e.run(t),t}function n(){return new b}e.run=t,e._makeResult=n}(v.prototype),r.TestRunner=v,g.displayName="TestLoader",function(e){function t(e){var t=new d(e.displayName),n=this.getTestCaseNames(e);for(var r=0;r<n.length;r++)t.push(new e(n[r]));return t}function n(e){var t=new d(o());for(var n=0;n<e.length;n++){var r=e[n],i=k.loadTestsFromTestCase(r);i.isEmpty()||t.push(i)}return t}function r(e){var t=[],n=e.prototype,r=this.testMethodPrefix;for(var i in n)i.indexOf(r)===0&&t.push(i);return t.sort()}function i(){return n(p.subclasses)}e.loadTestsFromTestCase=t,e.loadRegisteredTestCases=i,e.loadTestsFromTestCases=n,e.testMethodPrefix="test",e.getTestCaseNames=r}(g.prototype),r.TestLoader=g,function(){function e(e){var t=new this;e=e||t.retrieveOptions(),t.processOptions(e),t.autoRun&&t.run()}y.run=e,y.displayName="AutoRunner",y.LOGGERS={console:E,popup:S,command_line:x},y.RUNNERS={console:T}}(),function(t){function n(){var e=new this.logger(this.verbosity),t=new this.runner(e),n=k.loadRegisteredTestCases();return n._tests.length<=1&&(n=n._tests[0]),t.run(n)}function r(e){var t={};e=(e+"").match(/^(?:[^?#]*\?)([^#]+?)(?:#.*)?$/),e=e&&e[1];if(!e)return t;var n=e.split("&"),r=n.length;if(!r)return t;for(var i=0;i<r;i++){var s=n[i].split("="),o=decodeURIComponent(s[0]),u=s[1];u=u?decodeURIComponent(u):!0,t[o]=u}return t}function i(e){var t={};for(var n=0;n<e.length;n++){var r=e[n];if(r.indexOf("-")===0){var i=e[n+1];i&&i.indexOf("-")!==0?n++:i=!0,t[r.substr(1)]=i}}return t}function s(){return e.location?this.processQueryString(e.location):e.arguments?this.processArguments(e.arguments):{}}function o(t){for(var n in t){var r=t[n];switch(n){case"timeout":p.defaultTimeout=e.parseFloat(r)*1e3;break;case"run":this.autoRun=r==="false"?!1:!0;break;case"logger":this.logger=y.LOGGERS[r];break;case"verbosity":var i=e.parseInt(r);this.verbosity=e.isNaN(i)?E[r]:i;break;case"runner":this.runner=y.RUNNERS[r]}}}t.run=n,t.processQueryString=r,t.processArguments=i,t.retrieveOptions=s,t.processOptions=o}(y.prototype),r.AutoRunner=y,b.displayName="TestResult",function(e){function t(){this.assertionCount++}function n(e,t){this.skipCount++,this.skips.push(t)}function r(e,t){this.failureCount++,this.failures.push(t)}function i(e,t){this.errorCount++,this.errors.push(t)}function s(e){this.testCount++}function o(e){}function u(e){}function a(e){}function f(e){}function l(e){}function c(e){this.t0=e}function h(e){this.t1=e}function p(){return this.testCount+" tests, "+this.assertionCount+" assertions, "+this.failureCount+" failures, "+this.errorCount+" errors, "+this.skipCount+" skips"}e.addAssertion=t,e.addSkip=n,e.addFailure=r,e.addError=i,e.startTest=s,e.stopTest=o,e.pauseTest=u,e.restartTest=a,e.startSuite=f,e.stopSuite=l,e.start=c,e.stop=h,e.toString=p}(b.prototype),r.TestResult=b;var w={};E.displayName="Logger",E.LEVELS=["NOTSET","DEBUG","INFO","WARN","ERROR","CRITICAL"],E.CRITICAL=5,E.ERROR=4,E.WARN=3,E.INFO=2,E.DEBUG=1,E.NOTSET=0,function(t){function n(e,t){this.log(E.CRITICAL,e,t)}function r(e,t){this.log(E.ERROR,e,t)}function i(e,t){this.log(E.WARN,e,t)}function s(e,t){this.log(E.INFO,e,t)}function o(e,t){this.log(E.DEBUG,e,t)}function u(t,n,r){t=t||E.NOTSET;var i=e.console,s=E.LEVELS[t].toLowerCase();s==="critical"&&(s="error"),s=s in i?s:"log",t>=this.level&&(r?(r=r.slice(0),r.unshift(n),i[s].apply(i,r)):i[s](n))}t.log=u,t.critical=n,t.error=r,t.warn=i,t.info=s,t.debug=o,t.level=0}(E.prototype),w.Logger=E,u(S,E),S.displayName="PopupLogger",function(t){function i(e){return e.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/[\n\r]+/,"<br />")}function s(){var t=e.open("","popup","height=400,width=400"),n=t.document;return n.write('<!doctype html>               <html lang="en">                 <head>                   <meta charset="utf-8">                   <title>Console</title>                 </head>                 <body><div id="evidence_console"></div></body>               </html>'),n.close(),t.focus(),t}function o(e,t){this.popup=this.popup||this._makePopup();var s=E.LEVELS[e],o='<div style="';o+=n,o+=r[s]||"",o+='">',e>E.INFO&&(o+='<span style="font-weight: bold;">',o+=s,o+=":</span> "),o+=i(t),o+="</div>";var u=this.popup.document,a=u.createElement("div");a.innerHTML=o,o=a.firstChild,a=null,u.getElementById("evidence_console").appendChild(o)}function u(e,t,n){e=e||E.NOTSET,e>=this.level&&(n&&(t=C.printf(t,n)),this._appendLine(e,t))}var n="color: #333; background-color: #fff; font-family: monospace; border-bottom: 1px solid #ccc;",r={WARN:"color: #000; background-color: #fc6;",ERROR:"color: #f00; background-color: #fcc;",CRITICAL:"color: #fff; background-color: #000;"};t.log=u,t._makePopup=s,t._appendLine=o}(S.prototype),w.PopupLogger=S,u(x,E),x.displayName="CommandLineLogger",function(t){function n(t,n,r){t=t||E.NOTSET;if(t>=this.level){var i="";t>E.INFO&&(i=E.LEVELS[t]+": "),r&&(n=C.printf(n,r)),e.print(i+n)}}t.log=n}(x.prototype),w.CommandLineLogger=x,u(T,v),T.displayName="ConsoleTestRunner",function(e){function t(){return new N(this.logger)}e._makeResult=t}(T.prototype),w.TestRunner=T,u(N,b),N.displayName="ConsoleTestResult",function(e){function n(){this.assertionCount++}function r(e,n){t.addSkip.call(this,e,n),this.logger.warn("Skipping testcase "+e+": "+n.message)}function i(e,n){t.addFailure.call(this,e,n),this.logger.error(e+": "+n.message+" "+n.template,n.args)}function s(e,n){t.addError.call(this,e,n),this.logger.error(e+" threw an error. "+n)}function o(e){t.startTest.call(this,e),this.logger.debug("Started testcase "+e+".")}function u(e){this.logger.debug("Completed testcase "+e+".")}function a(e){this.logger.info("Paused testcase "+e+".")}function f(e){this.logger.info("Restarted testcase "+e+".")}function l(e){this.logger.info("Started suite "+e+".")}function c(e){this.logger.info("Completed suite "+e+".")}function h(e){t.start.call(this,e),this.logger.info("Started tests.")}function p(e){t.stop.call(this,e),this.logger.info("Completed tests in "+(e-this.t0)/1e3+"s."),this.logger.info(this.toString()+".")}var t=b.prototype;e.addAssertion=n,e.addSkip=r,e.addFailure=i,e.addError=s,e.startTest=o,e.stopTest=u,e.pauseTest=a,e.restartTest=f,e.startSuite=l,e.stopSuite=c,e.start=h,e.stop=p}(N.prototype),w.TestResult=N;var C=function(){function e(e,t,n){var r=[],i=/(^%|.%)([a-zA-Z])/,t=t.splice(0);n=n||String;if(e.length<=0)return"";while(m=i.exec(e)){var s=m[0],o=m.index,u,a;s.indexOf("%%")===0?(r.push(e.substr(0,o)),r.push(s.substr(1))):(r.push(e.substr(0,s.indexOf(!1)?o+1:o)),u=m[2],a=t.shift(),a=n(a,u),r.push(a)),e=e.substr(o+s.length)}return r.push(e),r.join("")}return{printf:e,Console:w}}();r.UI=C;var k=new g;r.defaultLoader=k,e.Evidence=r;if(e.location)e.onload=function(){typeof n=="function"&&n.call(e),y.run()};else if(e.arguments){var L=java.lang.Runtime.getRuntime(),A=new java.lang.Thread(function(){y.run()});L.addShutdownHook(A)}})(this);